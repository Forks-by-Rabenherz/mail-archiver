@inject Microsoft.Extensions.Localization.IStringLocalizer<MailArchiver.SharedResource> Localizer
@model MailArchiver.Models.ViewModels.MBoxImportViewModel
@{
    ViewData["Title"] = Localizer["ImportMBoxFileTitle"];
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>@Localizer["ImportMBoxFileTitle"]</h1>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> @Localizer["BackToAccounts"]
        </a>
    </div>

    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle-fill me-2"></i>
        <strong>@Localizer["MBoxImportInformation"]</strong>
        <ul class="mb-0 mt-2">
            <li>@Localizer["SupportedFormatsStandard"]</li>
            <li>@string.Format(Localizer["MaximumFileSize"], Model.MaxFileSizeFormatted)</li>
            <li>@Localizer["LargeFilesBackground"]</li>
            <li>@Localizer["DuplicateEmailsSkipped"]</li>
            <li>@Localizer["AllEmailsImported"]</li>
        </ul>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">@Localizer["UploadAndImportSettings"]</h5>
        </div>
        <div class="card-body">
            <form asp-action="ImportMBox" method="post" enctype="multipart/form-data" id="mboxImportForm">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                <div class="mb-4">
                    <label asp-for="MBoxFile" class="form-label">@Localizer["SelectMBoxFile"]</label>
                    <input asp-for="MBoxFile" type="file" class="form-control" accept=".mbox,.mbx,.eml" id="mboxFileInput">
                    <div class="form-text">
                        @string.Format(Localizer["SupportedFormatsWithMax"], Model.MaxFileSizeFormatted)
                    </div>
                    <span asp-validation-for="MBoxFile" class="text-danger"></span>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="TargetAccountId" class="form-label">@Localizer["TargetAccount"]</label>
                        <select asp-for="TargetAccountId" asp-items="Model.AvailableAccounts" class="form-select" id="accountSelect">
                            <option value="">@Localizer["PlaceholderSelectAccount"]</option>
                        </select>
                        <span asp-validation-for="TargetAccountId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="TargetFolder" class="form-label">@Localizer["TargetFolder"]</label>
                        <select asp-for="TargetFolder" class="form-select" id="folderSelect">
                            <option value="">@Localizer["PlaceholderSelectAccountFirst"]</option>
                            <option value="INBOX">INBOX</option>
                        </select>
                        <div class="form-text">
                            @Localizer["PlaceholderSelectAccountFirst"]
                        </div>
                        <span asp-validation-for="TargetFolder" class="text-danger"></span>
                    </div>
                </div>

                <div id="fileInfo" class="alert alert-secondary" style="display: none;">
                    <h6 class="mb-2">@Localizer["FileInformation"]</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <strong>@Localizer["FileNameLabel"]</strong> <span id="fileName"></span>
                        </div>
                        <div class="col-md-4">
                            <strong>@Localizer["FileSizeLabel"]</strong> <span id="fileSize"></span>
                        </div>
                        <div class="col-md-4">
                            <strong>@Localizer["EstimatedProcessingTime"]</strong> <span id="estimatedTime"></span>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>@Localizer["Important"]</strong> @Localizer["ImportBackgroundInfo1"] 
                    @Localizer["ImportBackgroundInfo2"]
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <div>
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="bi bi-upload me-2"></i>@Localizer["StartImport"]
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary ms-2">@Localizer["Cancel"]</a>
                    </div>
                    <div>
                        <a asp-controller="Emails" asp-action="Jobs" class="btn btn-outline-info">
                            <i class="bi bi-clock-history me-1"></i>@Localizer["ViewImportJobs"]
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            // File input change handler
            $('#mboxFileInput').on('change', function() {
                const file = this.files[0];
                const submitBtn = $('#submitBtn');
                const fileInfo = $('#fileInfo');
                
                if (file) {
                    // Show file information
                    $('#fileName').text(file.name);
                    $('#fileSize').text(formatFileSize(file.size));
                    
                    // Estimate processing time (rough estimate: 1MB per 10 seconds)
                    const estimatedMinutes = Math.ceil((file.size / 1024 / 1024) / 6);
                    let timeText = estimatedMinutes < 60 
                        ? estimatedMinutes + ' minutes' 
                        : Math.ceil(estimatedMinutes / 60) + ' hours';
                    $('#estimatedTime').text(timeText);
                    
                    fileInfo.show();
                    
                    // Check file size
                    const maxSize = @Model.MaxFileSize;
                    if (file.size > maxSize) {
                        alert('@string.Format(Localizer["FileSizeExceedsMax"], Model.MaxFileSizeFormatted)');
                        submitBtn.prop('disabled', true);
                        return;
                    }
                    
                    // Enable submit if account is also selected
                    updateSubmitButton();
                } else {
                    fileInfo.hide();
                    submitBtn.prop('disabled', true);
                }
            });

            // Account selection change handler
            $('#accountSelect').change(function () {
                const accountId = $(this).val();
                updateSubmitButton();
                
                if (accountId) {
                    $('#folderSelect').html('<option>@Localizer["LoadingFolders"]</option>');
                    
                    $.ajax({
                        url: '@Url.Action("GetFolders", "MailAccounts")',
                        data: { accountId: accountId },
                        type: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            let options = '<option value="">@Localizer["PlaceholderSelectFolder"]</option>';
                            let inboxFound = false;
                            
                            $.each(data, function (index, folderName) {
                                options += '<option value="' + folderName + '">' + folderName + '</option>';
                                if (folderName.toUpperCase() === 'INBOX') {
                                    inboxFound = true;
                                }
                            });
                            
                            $('#folderSelect').html(options);
                            
                            if (inboxFound) {
                                $("#folderSelect option").filter(function () {
                                    return this.value.toUpperCase() === 'INBOX';
                                }).prop('selected', true);
                            }
                            
                            updateSubmitButton();
                        },
                        error: function () {
                            $('#folderSelect').html('<option value="">@Localizer["ErrorLoadingFolders"]</option><option value="INBOX">INBOX</option>');
                        }
                    });
                } else {
                    $('#folderSelect').html('<option value="">@Localizer["PlaceholderSelectAccountFirst"]</option>');
                }
            });

            // Folder selection change handler
            $('#folderSelect').change(function() {
                updateSubmitButton();
            });

            function updateSubmitButton() {
                const hasFile = $('#mboxFileInput')[0].files.length > 0;
                const hasAccount = $('#accountSelect').val() !== '';
                const hasFolder = $('#folderSelect').val() !== '';
                
                $('#submitBtn').prop('disabled', !(hasFile && hasAccount && hasFolder));
            }

            function formatFileSize(bytes) {
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                if (bytes === 0) return '0 B';
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
            }

            // Form submission handler with progress indication
            $('#mboxImportForm').on('submit', function(e) {
                const submitBtn = $('#submitBtn');
                submitBtn.html('<i class="bi bi-hourglass-split me-2"></i>@Localizer["StartingImport"]');
                submitBtn.prop('disabled', true);
                
                // Show processing message
                const processingAlert = $('<div class="alert alert-info mt-3">' +
                    '<i class="bi bi-clock-history me-2"></i>' +
                    '@Localizer["UploadInProgress"]' +
                    '</div>');
                $(this).after(processingAlert);
            });

            // Auto-select account if there's only one
            if ($('#accountSelect option').length === 2) {
                $('#accountSelect option:last').prop('selected', true);
                $('#accountSelect').trigger('change');
            }
        });
    </script>
}
